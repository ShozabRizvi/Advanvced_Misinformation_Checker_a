<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2300FFF0'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI-Powered Security & Fact Verification Platform</title>
<!-- Professional Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- React and ReactDOM -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<!-- Babel for JSX -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<!-- 🔴 NEW: Enhanced AI Features -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
tailwind.config = {
theme: {
extend: {
colors: {
'accent-blue': '#3B82F6',
'accent-cyan': '#06B6D4',
'accent-indigo': '#6366F1',
'accent-purple': '#8B5CF6',
'accent-violet': '#7C3AED',
'surface': '#0f172a',
'surface-light': '#1e293b',
},
fontFamily: {
'sans': ['Inter', 'system-ui', 'sans-serif'],
'mono': ['JetBrains Mono', 'monospace'],
'display': ['Space Grotesk', 'Inter', 'sans-serif'],
},
animation: {
'fade-in': 'fade-in 0.5s ease-out',
'typing-cursor': 'typing-cursor 1s infinite',
'flow-gradient': 'flow-gradient 15s ease-in-out infinite',
'subtle-glow': 'subtle-glow 3s ease-in-out infinite alternate',
'pulse-mic': 'pulse-mic 1s ease-in-out infinite',
},
}
}
}
</script>

<style>
@keyframes fade-in {
0% { opacity: 0; transform: translateY(10px); }
100% { opacity: 1; transform: translateY(0); }
}

@keyframes typing-cursor {
0%, 50% { opacity: 1; }
51%, 100% { opacity: 0; }
}

@keyframes flow-gradient {
0%, 100% { background-position: 0% 50%; }
50% { background-position: 100% 50%; }
}

@keyframes subtle-glow {
0% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
100% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
}

@keyframes pulse-mic {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.1); }
}

/* Beautiful Flowing Background */
body {
background: linear-gradient(
-45deg,
#1e3a8a,
#1e40af,
#3730a3,
#4338ca,
#6366f1,
#0ea5e9,
#06b6d4,
#0891b2,
#1e293b
);
background-size: 400% 400%;
animation: flow-gradient 15s ease-in-out infinite;
min-height: 100vh;
color: white;
}

.glass-panel {
background: rgba(15, 23, 42, 0.85);
backdrop-filter: blur(12px);
border: 1px solid rgba(59, 130, 246, 0.3);
}

.glass-panel-elevated {
background: rgba(30, 41, 59, 0.9);
backdrop-filter: blur(15px);
border: 1px solid rgba(59, 130, 246, 0.4);
}

.streaming-cursor {
display: inline-block;
width: 2px;
height: 1.2em;
background: #3B82F6;
margin-left: 2px;
animation: typing-cursor 1s infinite;
box-shadow: 0 0 8px #3B82F6;
}

.voice-visualizer {
display: flex;
align-items: center;
gap: 3px;
height: 20px;
}

.voice-bar {
width: 3px;
background: linear-gradient(to top, #3B82F6, #06B6D4);
border-radius: 2px;
transition: all 0.1s ease;
}

.professional-button {
background: linear-gradient(135deg, #3B82F6, #06B6D4);
transition: all 0.3s ease;
}

.professional-button:hover {
background: linear-gradient(135deg, #2563EB, #0891B2);
box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
transform: translateY(-2px);
}

/* Mobile Responsive Adjustments */
@media (max-width: 768px) {
.glass-panel {
border-radius: 12px;
}
}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

// 🔴 ENHANCED: User Settings Context with new AI features
const UserSettingsContext = createContext(null);

const UserSettingsProvider = ({ children }) => {
  const [settings, setSettings] = useState(() => {
    const saved = localStorage.getItem('platform_user_settings');
    return saved ? JSON.parse(saved) : {
      spamFilters: {
        jobs: true,
        advertisements: false,
        promotions: false,
        internships: true,
        banking: true
      },
      callSettings: {
        recordingEnabled: false,
        spamBlocking: true,
        screeningEnabled: false
      },
      communitySettings: {
        notifications: true,
        shareReports: false
      },
      // 🔴 NEW: Advanced AI Features
      aiSettings: {
        multiSourceVerification: true,
        voiceAnalysis: true,
        behaviorTracking: true,
        predictiveAlerts: true,
        edgeProcessing: true
      },
      languageSettings: {
        primary: 'en',
        secondary: 'hi',
        autoDetect: true
      },
      privacySettings: {
        dataSharing: false,
        anonymousReporting: true,
        localProcessing: true
      },
      isAdmin: false
    };
  });

  // 🔴 NEW: Analytics tracking
  const [userAnalytics, setUserAnalytics] = useState({
    threatLevel: 'LOW',
    riskScore: 0,
    behaviorPattern: [],
    communityContributions: 0,
    fraudsDetected: 0,
    educationProgress: 0
  });

  useEffect(() => {
    localStorage.setItem('platform_user_settings', JSON.stringify(settings));
  }, [settings]);

  return (
    <UserSettingsContext.Provider value={{ 
      settings, 
      setSettings, 
      userAnalytics, 
      setUserAnalytics 
    }}>
      {children}
    </UserSettingsContext.Provider>
  );
};

const useUserSettings = () => useContext(UserSettingsContext);

// Local Storage Keys (EXISTING)
const API_KEY_STORAGE = 'openrouter_api_key';
const SETTINGS_STORAGE = 'fact_checker_settings';

// 🔴 NEW: Advanced AI Services
const AdvancedAIServices = {
  // Multi-source truth synthesis
  synthesizeTruth: async (query) => {
    const sources = [];
    let overallConfidence = 0;
    
    try {
      // Wikipedia verification
      const wikiResponse = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
      if (wikiResponse.ok) {
        const wikiData = await wikiResponse.json();
        sources.push({
          name: 'Wikipedia',
          content: wikiData.extract?.substring(0, 200) + '...',
          confidence: 0.8,
          type: 'encyclopedia',
          url: wikiData.content_urls?.desktop?.page
        });
        overallConfidence += 0.3;
      }
    } catch (error) {
      console.log('Wikipedia lookup failed:', error);
    }

    // Add mock sources for demo
    sources.push({
      name: 'Fact Check Database',
      content: 'Cross-referencing with known fact-checking databases...',
      confidence: 0.7,
      type: 'fact-check'
    });

    return {
      sources,
      overallConfidence: Math.min(overallConfidence + 0.4, 0.9),
      recommendation: overallConfidence > 0.6 ? 'VERIFIED' : 'NEEDS_VERIFICATION',
      riskLevel: overallConfidence > 0.7 ? 'LOW' : overallConfidence > 0.4 ? 'MEDIUM' : 'HIGH'
    };
  },

  // Enhanced behavior analysis
  analyzeBehavior: (text, userHistory = []) => {
    const patterns = {
      urgency: ['urgent', 'immediately', 'act now', 'limited time', 'expires today', 'hurry'],
      fear: ['suspended', 'blocked', 'legal action', 'arrest', 'fine', 'terminated', 'cancelled'],
      authority: ['government', 'bank', 'police', 'tax department', 'official', 'ministry', 'RBI'],
      financial: ['money', 'refund', 'payment', 'account', 'transfer', 'reward', 'prize', 'loan'],
      personal: ['verify', 'confirm', 'update', 'provide', 'send', 'share', 'details']
    };

    let riskScore = 0;
    let detectedPatterns = [];
    let recommendations = [];

    Object.entries(patterns).forEach(([category, keywords]) => {
      const matches = keywords.filter(keyword => 
        text.toLowerCase().includes(keyword.toLowerCase())
      );
      
      if (matches.length > 0) {
        const categoryRisk = {
          urgency: 3,
          fear: 4,
          authority: 2,
          financial: 3,
          personal: 2
        };
        
        riskScore += matches.length * categoryRisk[category];
        detectedPatterns.push({
          category,
          matches,
          risk: categoryRisk[category]
        });
      }
    });

    // Generate recommendations
    if (riskScore > 8) {
      recommendations.push('🚨 HIGH RISK: This appears to be a scam attempt');
      recommendations.push('❌ DO NOT provide personal information');
      recommendations.push('📞 Verify independently before taking action');
    } else if (riskScore > 4) {
      recommendations.push('⚠️ MEDIUM RISK: Exercise caution');
      recommendations.push('🔍 Verify information independently');
    } else {
      recommendations.push('✅ LOW RISK: Appears relatively safe');
    }

    return {
      riskScore: Math.min(riskScore, 10),
      patterns: detectedPatterns,
      recommendations,
      riskLevel: riskScore > 8 ? 'HIGH' : riskScore > 4 ? 'MEDIUM' : 'LOW'
    };
  },

  // Language detection
  detectLanguage: (text) => {
    const patterns = {
      hindi: /[\u0900-\u097F]/,
      tamil: /[\u0B80-\u0BFF]/,
      bengali: /[\u0980-\u09FF]/,
      gujarati: /[\u0A80-\u0AFF]/,
      punjabi: /[\u0A00-\u0A7F]/,
      telugu: /[\u0C00-\u0C7F]/,
      marathi: /[\u0900-\u097F]/
    };

    for (const [lang, pattern] of Object.entries(patterns)) {
      if (pattern.test(text)) {
        return { language: lang, confidence: 0.8 };
      }
    }
    return { language: 'english', confidence: 0.9 };
  },

  // Predictive threat analysis
  predictThreats: () => {
    const currentMonth = new Date().getMonth();
    const threats = {
      0: ['New Year loan scams', 'Resolution-based frauds'],
      1: ['Valentine gift scams', 'Fake charity appeals'],
      2: ['Tax season phishing', 'Refund fraud'],
      3: ['Festival season scams', 'Holi-related frauds'],
      4: ['Summer vacation scams', 'Travel frauds'],
      5: ['Monsoon insurance frauds', 'Weather-related scams'],
      6: ['Admission season frauds', 'Education loan scams'],
      7: ['Independence Day frauds', 'Patriotic-themed scams'],
      8: ['Ganesh festival scams', 'Religious frauds'],
      9: ['Diwali shopping scams', 'Festival loan frauds'],
      10: ['Wedding season frauds', 'Jewelry scams'],
      11: ['Year-end bonus scams', 'Holiday frauds']
    };

    return {
      currentThreats: threats[currentMonth] || ['General scams'],
      riskLevel: 'MEDIUM',
      recommendations: [
        'Be extra cautious during festival seasons',
        'Verify all financial offers independently',
        'Use official channels for government services'
      ]
    };
  }
};

// 🔴 NEW: Community Intelligence System
const CommunityServices = {
  submitReport: async (reportData) => {
    const report = {
      id: Date.now().toString(),
      ...reportData,
      timestamp: new Date().toISOString(),
      verified: false,
      votes: 0,
      region: 'India', // Can be enhanced with geolocation
      category: reportData.category || 'general'
    };
    
    const existingReports = JSON.parse(localStorage.getItem('community_reports') || '[]');
    existingReports.unshift(report); // Add to beginning
    
    // Keep only last 100 reports for demo
    const recentReports = existingReports.slice(0, 100);
    localStorage.setItem('community_reports', JSON.stringify(recentReports));
    
    return report;
  },

  getReports: (limit = 20) => {
    const reports = JSON.parse(localStorage.getItem('community_reports') || '[]');
    return reports.slice(0, limit);
  },

  getThreatLevel: () => {
    const reports = CommunityServices.getReports(50);
    const last24Hours = reports.filter(r => 
      new Date() - new Date(r.timestamp) < 24 * 60 * 60 * 1000
    );
    
    if (last24Hours.length > 15) return 'HIGH';
    if (last24Hours.length > 8) return 'MEDIUM';
    return 'LOW';
  },

  getRegionalStats: () => {
    const reports = CommunityServices.getReports(100);
    const categories = {};
    
    reports.forEach(report => {
      categories[report.category] = (categories[report.category] || 0) + 1;
    });

    return {
      totalReports: reports.length,
      categories,
      topThreat: Object.keys(categories).reduce((a, b) => 
        categories[a] > categories[b] ? a : b, 'phishing'
      )
    };
  }
};

// Utility function to create short summary (EXISTING)
const createSummary = (text, maxLength = 200) => {
  if (!text || text.length <= maxLength) return text;
  const sentences = text.match(/[^\.!?]+[\.!?]+/g) || [];
  let summary = '';
  for (const sentence of sentences) {
    if ((summary + sentence).length <= maxLength) {
      summary += sentence;
    } else {
      break;
    }
  }
  if (!summary) {
    summary = text.substring(0, maxLength).trim() + '...';
  }
  return summary.trim();
};

// API Key Manager Component (EXISTING - UNCHANGED)
const ApiKeyManager = ({ apiKey, onApiKeyChange }) => {
  const [isEditing, setIsEditing] = useState(!apiKey);
  const [tempKey, setTempKey] = useState(apiKey || '');
  const [showKey, setShowKey] = useState(false);

  const handleSave = () => {
    if (tempKey.trim()) {
      onApiKeyChange(tempKey.trim());
      setIsEditing(false);
      localStorage.setItem(API_KEY_STORAGE, tempKey.trim());
    }
  };

  const handleClear = () => {
    onApiKeyChange('');
    setTempKey('');
    setIsEditing(true);
    localStorage.removeItem(API_KEY_STORAGE);
  };

  const maskKey = (key) => {
    if (!key) return 'Not configured';
    return key.substring(0, 8) + '••••••••••••••••••••••••••••••';
  };

  return (
    <div className="glass-panel p-4 rounded-xl mb-4 border border-blue-400/40">
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-lg font-semibold text-blue-300 flex items-center gap-2">
          🔑 OpenRouter API Key
        </h3>
        <div className="flex gap-2">
          {apiKey && !isEditing && (
            <button
              onClick={() => setShowKey(!showKey)}
              className="p-2 text-xs rounded-lg glass-panel border-gray-600 text-gray-300 hover:border-blue-400 transition-colors"
              title={showKey ? 'Hide key' : 'Show key'}
            >
              {showKey ? '🙈' : '👁️'}
            </button>
          )}
          {apiKey && !isEditing && (
            <button
              onClick={() => setIsEditing(true)}
              className="p-2 text-xs rounded-lg glass-panel border-blue-400/50 text-blue-300 hover:border-blue-400 transition-colors"
            >
              ✏️ Edit
            </button>
          )}
          {apiKey && (
            <button
              onClick={handleClear}
              className="p-2 text-xs rounded-lg glass-panel border-red-400/50 text-red-300 hover:border-red-400 transition-colors"
            >
              🗑️ Clear
            </button>
          )}
        </div>
      </div>

      {isEditing ? (
        <div className="space-y-3">
          <input
            type="password"
            value={tempKey}
            onChange={(e) => setTempKey(e.target.value)}
            placeholder="Enter your OpenRouter API key (sk-or-v1-...)"
            className="w-full p-3 rounded-lg bg-surface border border-blue-400/40 text-gray-100 placeholder-gray-400 focus:border-blue-400 focus:outline-none transition-colors font-mono text-sm"
          />
          <div className="flex gap-2 flex-wrap">
            <button
              onClick={handleSave}
              disabled={!tempKey.trim()}
              className="px-4 py-2 rounded-lg professional-button text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed text-sm"
            >
              💾 Save Key
            </button>
            {apiKey && (
              <button
                onClick={() => {
                  setIsEditing(false);
                  setTempKey(apiKey);
                }}
                className="px-4 py-2 rounded-lg glass-panel border border-gray-600 text-gray-300 hover:border-blue-400 transition-colors text-sm"
              >
                ❌ Cancel
              </button>
            )}
          </div>
          <p className="text-xs text-gray-400 leading-relaxed">
            Get your API key from <a href="https://openrouter.ai/keys" target="_blank" className="text-blue-400 hover:text-blue-300">openrouter.ai/keys</a>.
            Your key is stored locally and never sent to our servers.
          </p>
        </div>
      ) : (
        <div className="flex items-center justify-between">
          <div className="font-mono text-sm text-gray-300">
            {showKey ? apiKey : maskKey(apiKey)}
          </div>
          <div className="text-xs text-green-400">✅ Configured</div>
        </div>
      )}
    </div>
  );
};

// Voice Visualizer (EXISTING - UNCHANGED)
const VoiceVisualizer = ({ isActive }) => (
  <div className="voice-visualizer">
    {[...Array(5)].map((_, i) => (
      <div
        key={i}
        className="voice-bar"
        style={{
          height: isActive ? `${8 + Math.random() * 12}px` : '4px',
          filter: isActive ? 'drop-shadow(0 0 3px currentColor)' : 'none'
        }}
      />
    ))}
  </div>
);

// Status Component (EXISTING - UNCHANGED)
const StatusIndicator = ({ status, isProcessing, isStreaming, apiKey }) => (
  <div className="flex items-center gap-2 lg:gap-4 flex-wrap">
    <div className={`
      px-3 lg:px-6 py-2 lg:py-3 rounded-lg font-medium text-xs lg:text-sm transition-all duration-500 glass-panel
      ${isStreaming ? 'border-cyan-400 text-cyan-300 animate-subtle-glow' :
        isProcessing ? 'border-blue-400 text-blue-300' :
        apiKey ? 'border-green-400 text-green-300' : 'border-red-400 text-red-300'}
    `}>
      <div className="flex items-center gap-2 lg:gap-3">
        <div className={`w-2 lg:w-3 h-2 lg:h-3 rounded-full ${
          isStreaming ? 'bg-cyan-400' :
          isProcessing ? 'bg-blue-400 animate-pulse' :
          apiKey ? 'bg-green-400' : 'bg-red-400'
        }`} />
        <div className="font-semibold">
          {isStreaming ? 'Analyzing' :
          isProcessing ? 'Processing' :
          apiKey ? 'Ready' : 'API Key Required'}
        </div>
      </div>
    </div>
    <div className="text-xs font-mono text-gray-300 px-2 lg:px-4 py-1 lg:py-2 rounded-lg glass-panel">
      API: <span className={apiKey ? "text-green-400" : "text-red-400"}>
        {apiKey ? '✅ Set' : '❌ Missing'}
      </span>
    </div>
  </div>
);

// Navigation Component (EXISTING - ENHANCED)
const NavigationTabs = ({ activeSection, onSectionChange }) => (
  <div className="flex gap-2 mt-4 flex-wrap">
    {[
      { id: 'engine', label: '🤖 AI Engine', icon: '🔍' },
      { id: 'analytics', label: '📊 Analytics', icon: '📈' }, // 🔴 NEW
      { id: 'dialer', label: '📞 Dialer', icon: '☎️' },
      { id: 'community', label: '👥 Community', icon: '⚠️' },
      { id: 'spam', label: '🛡️ Spam Control', icon: '🚫' },
      { id: 'education', label: '🎓 Education', icon: '📚' }, // 🔴 NEW
      { id: 'admin', label: '🔐 Admin', icon: '👮' }
    ].map(section => (
      <button
        key={section.id}
        onClick={() => onSectionChange(section.id)}
        className={`px-3 lg:px-4 py-2 rounded-lg font-medium text-xs lg:text-sm transition-all duration-300 ${
          activeSection === section.id
          ? 'bg-blue-600 text-white border border-blue-500'
          : 'glass-panel border border-blue-400/50 text-blue-300 hover:border-blue-400'
        }`}
      >
        <span className="hidden sm:inline">{section.label}</span>
        <span className="sm:hidden">{section.icon}</span>
      </button>
    ))}
  </div>
);

// 🔴 NEW: Advanced Analytics Dashboard
const AdvancedAnalyticsSection = () => {
  const { userAnalytics, setUserAnalytics } = useUserSettings();
  const [threatData, setThreatData] = useState(null);
  const [communityStats, setCommunityStats] = useState(null);

  useEffect(() => {
    // Load threat analysis
    const threats = AdvancedAIServices.predictThreats();
    const stats = CommunityServices.getRegionalStats();
    const currentThreat = CommunityServices.getThreatLevel();
    
    setThreatData({
      ...threats,
      currentLevel: currentThreat
    });
    setCommunityStats(stats);

    // Update user analytics with demo data
    setUserAnalytics(prev => ({
      ...prev,
      threatLevel: currentThreat,
      riskScore: Math.floor(Math.random() * 10),
      fraudsDetected: prev.fraudsDetected || Math.floor(Math.random() * 25),
      educationProgress: prev.educationProgress || Math.floor(Math.random() * 100)
    }));
  }, [setUserAnalytics]);

  return (
    <div className="space-y-6">
      <div className="glass-panel-elevated p-6 rounded-2xl">
        <h3 className="text-2xl font-bold text-blue-300 mb-6 flex items-center gap-3">
          📊 Advanced Threat Intelligence
        </h3>

        {/* Real-time Threat Overview */}
        <div className="grid md:grid-cols-4 gap-4 mb-6">
          <div className={`glass-panel p-4 rounded-xl text-center border ${
            threatData?.currentLevel === 'HIGH' ? 'border-red-400/50' :
            threatData?.currentLevel === 'MEDIUM' ? 'border-yellow-400/50' : 'border-green-400/50'
          }`}>
            <div className={`text-2xl font-bold ${
              threatData?.currentLevel === 'HIGH' ? 'text-red-400' :
              threatData?.currentLevel === 'MEDIUM' ? 'text-yellow-400' : 'text-green-400'
            }`}>
              {threatData?.currentLevel || 'LOW'}
            </div>
            <div className="text-gray-400 text-xs">Current Threat Level</div>
          </div>
          
          <div className="glass-panel p-4 rounded-xl text-center">
            <div className="text-2xl font-bold text-blue-400">{userAnalytics.riskScore}/10</div>
            <div className="text-gray-400 text-xs">Personal Risk Score</div>
          </div>
          
          <div className="glass-panel p-4 rounded-xl text-center">
            <div className="text-2xl font-bold text-purple-400">{userAnalytics.fraudsDetected}</div>
            <div className="text-gray-400 text-xs">Frauds Detected</div>
          </div>

          <div className="glass-panel p-4 rounded-xl text-center">
            <div className="text-2xl font-bold text-green-400">{communityStats?.totalReports || 0}</div>
            <div className="text-gray-400 text-xs">Community Reports</div>
          </div>
        </div>

        {/* Predictive Threats */}
        <div className="grid md:grid-cols-2 gap-6 mb-6">
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4">🔮 Predicted Threats</h4>
            <div className="space-y-2">
              {threatData?.currentThreats?.map((threat, index) => (
                <div key={index} className="p-2 bg-yellow-900/30 rounded text-yellow-300 text-sm">
                  ⚠️ {threat}
                </div>
              )) || <div className="text-gray-400">Loading predictions...</div>}
            </div>
          </div>

          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4">🏆 Your Security Score</h4>
            <div className="space-y-3">
              <div className="flex justify-between items-center">
                <span className="text-gray-300">Fraud Detection</span>
                <span className="text-green-400">{userAnalytics.fraudsDetected > 10 ? 'Expert' : 'Learning'}</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-gray-300">Education Progress</span>
                <span className="text-blue-400">{userAnalytics.educationProgress}%</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-gray-300">Community Contribution</span>
                <span className="text-purple-400">{userAnalytics.communityContributions} reports</span>
              </div>
            </div>
          </div>
        </div>

        {/* Regional Intelligence */}
        <div className="glass-panel p-4 rounded-xl">
          <h4 className="font-semibold text-cyan-300 mb-4">🗺️ Regional Threat Intelligence</h4>
          <div className="grid md:grid-cols-3 gap-4">
            <div className="text-center p-3 bg-red-900/30 rounded-lg">
              <div className="text-lg font-bold text-red-400">High Risk</div>
              <div className="text-xs text-gray-400">Tax Season Scams</div>
            </div>
            <div className="text-center p-3 bg-yellow-900/30 rounded-lg">
              <div className="text-lg font-bold text-yellow-400">Medium Risk</div>
              <div className="text-xs text-gray-400">Festival Frauds</div>
            </div>
            <div className="text-center p-3 bg-blue-900/30 rounded-lg">
              <div className="text-lg font-bold text-blue-400">Trending</div>
              <div className="text-xs text-gray-400">{communityStats?.topThreat || 'Phishing'}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// 🔴 NEW: Education Section
const EducationSection = () => {
  const { settings, userAnalytics, setUserAnalytics } = useUserSettings();
  const [currentLesson, setCurrentLesson] = useState(0);
  const [quizScore, setQuizScore] = useState(0);

  const lessons = [
    {
      id: 1,
      title: "Identifying Phishing Attempts",
      content: "Learn to recognize fake emails and messages that try to steal your information.",
      quiz: {
        question: "Which of these is a red flag in an email?",
        options: ["Urgent action required", "From known sender", "Proper grammar", "Clear subject"],
        correct: 0
      },
      badge: "🎣 Phishing Detector"
    },
    {
      id: 2,
      title: "Voice Scam Recognition",
      content: "Understand common phone scam tactics and how to respond safely.",
      quiz: {
        question: "What should you do when someone claims to be from your bank?",
        options: ["Provide details", "Hang up and call bank", "Ask questions", "Transfer money"],
        correct: 1
      },
      badge: "📞 Voice Defender"
    },
    {
      id: 3,
      title: "Social Engineering Awareness",
      content: "Recognize psychological manipulation techniques used by fraudsters.",
      quiz: {
        question: "Social engineering often relies on:",
        options: ["Technical skills", "Human psychology", "Computer viruses", "Fake websites"],
        correct: 1
      },
      badge: "🧠 Mind Guardian"
    }
  ];

  const handleQuizAnswer = (selectedAnswer) => {
    const isCorrect = selectedAnswer === lessons[currentLesson].quiz.correct;
    if (isCorrect) {
      setQuizScore(prev => prev + 1);
      setUserAnalytics(prev => ({
        ...prev,
        educationProgress: Math.min(prev.educationProgress + 10, 100)
      }));
    }
    
    setTimeout(() => {
      if (currentLesson < lessons.length - 1) {
        setCurrentLesson(prev => prev + 1);
      }
    }, 1500);
  };

  return (
    <div className="space-y-6">
      <div className="glass-panel-elevated p-6 rounded-2xl">
        <h3 className="text-2xl font-bold text-blue-300 mb-6 flex items-center gap-3">
          🎓 Interactive Fraud Education
        </h3>

        {/* Progress Overview */}
        <div className="mb-6 glass-panel p-4 rounded-xl">
          <div className="flex justify-between items-center mb-2">
            <span className="text-gray-300">Education Progress</span>
            <span className="text-blue-400">{userAnalytics.educationProgress}%</span>
          </div>
          <div className="w-full bg-gray-700 rounded-full h-2">
            <div 
              className="bg-gradient-to-r from-blue-500 to-cyan-500 h-2 rounded-full transition-all duration-500"
              style={{ width: `${userAnalytics.educationProgress}%` }}
            ></div>
          </div>
        </div>

        {/* Current Lesson */}
        <div className="glass-panel p-6 rounded-xl mb-6">
          <div className="flex justify-between items-center mb-4">
            <h4 className="text-xl font-semibold text-cyan-300">
              Lesson {currentLesson + 1}: {lessons[currentLesson].title}
            </h4>
            <div className="text-sm text-gray-400">
              {currentLesson + 1} / {lessons.length}
            </div>
          </div>

          <p className="text-gray-300 mb-6 leading-relaxed">
            {lessons[currentLesson].content}
          </p>

          {/* Quiz Section */}
          <div className="bg-blue-900/30 p-4 rounded-lg">
            <h5 className="font-semibold text-blue-300 mb-3">Quick Quiz:</h5>
            <p className="text-gray-300 mb-4">{lessons[currentLesson].quiz.question}</p>
            
            <div className="grid gap-2">
              {lessons[currentLesson].quiz.options.map((option, index) => (
                <button
                  key={index}
                  onClick={() => handleQuizAnswer(index)}
                  className="p-3 text-left rounded-lg glass-panel border border-blue-400/50 text-blue-300 hover:border-blue-400 transition-all duration-300"
                >
                  {option}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Achievement Badges */}
        <div className="glass-panel p-4 rounded-xl">
          <h4 className="font-semibold text-cyan-300 mb-4">🏆 Achievement Badges</h4>
          <div className="flex flex-wrap gap-3">
            {lessons.slice(0, currentLesson + 1).map((lesson, index) => (
              <div key={lesson.id} className="flex items-center gap-2 bg-green-900/30 px-3 py-2 rounded-lg">
                <span className="text-lg">{lesson.badge.split(' ')[0]}</span>
                <span className="text-green-400 text-sm font-semibold">
                  {lesson.badge.split(' ').slice(1).join(' ')}
                </span>
              </div>
            ))}
          </div>
        </div>

        {/* Fraud Simulation Game */}
        <div className="glass-panel p-4 rounded-xl">
          <h4 className="font-semibold text-cyan-300 mb-4">🎮 Fraud Simulation Game</h4>
          <p className="text-gray-300 mb-4">
            Practice identifying scams in a safe environment. No real information at risk!
          </p>
          <button className="px-4 py-2 professional-button text-white rounded-lg">
            🚀 Start Simulation
          </button>
        </div>
      </div>
    </div>
  );
};

// Dialer Section (EXISTING - UNCHANGED)
const DialerSection = () => {
  const { settings, setSettings } = useUserSettings();

  return (
    <div className="space-y-6">
      <div className="glass-panel-elevated p-6 rounded-2xl">
        <h3 className="text-2xl font-bold text-blue-300 mb-6 flex items-center gap-3">
          📞 Call Management Center
        </h3>
        <div className="grid md:grid-cols-2 gap-6">
          {/* Call Recording Section */}
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4 flex items-center gap-2">
              🎙️ Call Recording
            </h4>
            <div className="space-y-3">
              <div className="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-3">
                <p className="text-yellow-300 text-sm mb-2">⚠️ Legal Notice</p>
                <p className="text-gray-300 text-xs">
                  Recording calls requires explicit consent from all parties.
                  Laws vary by state - ensure compliance before enabling.
                </p>
              </div>
              <label className="flex items-center gap-3">
                <input
                  type="checkbox"
                  checked={settings.callSettings.recordingEnabled}
                  onChange={(e) => setSettings(prev => ({
                    ...prev,
                    callSettings: {
                      ...prev.callSettings,
                      recordingEnabled: e.target.checked
                    }
                  }))}
                  className="rounded"
                />
                <span className="text-gray-300">Enable call recording (with consent)</span>
              </label>
            </div>
          </div>

          {/* Spam Detection Section */}
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4 flex items-center gap-2">
              🛡️ Spam Detection
            </h4>
            <div className="space-y-3">
              <label className="flex items-center gap-3">
                <input
                  type="checkbox"
                  checked={settings.callSettings.spamBlocking}
                  onChange={(e) => setSettings(prev => ({
                    ...prev,
                    callSettings: {
                      ...prev.callSettings,
                      spamBlocking: e.target.checked
                    }
                  }))}
                  className="rounded"
                />
                <span className="text-gray-300">Block suspected spam calls</span>
              </label>
              <label className="flex items-center gap-3">
                <input
                  type="checkbox"
                  checked={settings.callSettings.screeningEnabled}
                  onChange={(e) => setSettings(prev => ({
                    ...prev,
                    callSettings: {
                      ...prev.callSettings,
                      screeningEnabled: e.target.checked
                    }
                  }))}
                  className="rounded"
                />
                <span className="text-gray-300">AI call screening (coming soon)</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// Community Section (EXISTING - ENHANCED)
const CommunitySection = () => {
  const { settings, setSettings, userAnalytics, setUserAnalytics } = useUserSettings();
  const [reports, setReports] = useState([]);
  const [newReport, setNewReport] = useState({ type: '', description: '', phoneNumber: '' });

  useEffect(() => {
    const communityReports = CommunityServices.getReports(10);
    setReports(communityReports);
  }, []);

  const submitReport = async () => {
    if (!newReport.description.trim()) return;

    const report = await CommunityServices.submitReport({
      ...newReport,
      category: newReport.type || 'general'
    });

    setReports(prev => [report, ...prev.slice(0, 9)]);
    setNewReport({ type: '', description: '', phoneNumber: '' });
    
    // Update user analytics
    setUserAnalytics(prev => ({
      ...prev,
      communityContributions: prev.communityContributions + 1
    }));
  };

  return (
    <div className="space-y-6">
      <div className="glass-panel-elevated p-6 rounded-2xl">
        <h3 className="text-2xl font-bold text-blue-300 mb-6 flex items-center gap-3">
          👥 Community Fraud Awareness
        </h3>

        {/* 🔴 ENHANCED: Report Submission */}
        <div className="glass-panel p-4 rounded-xl mb-6">
          <h4 className="font-semibold text-cyan-300 mb-4">📢 Submit Fraud Report</h4>
          <div className="space-y-3">
            <select
              value={newReport.type}
              onChange={(e) => setNewReport(prev => ({ ...prev, type: e.target.value }))}
              className="w-full p-3 rounded-lg bg-surface border border-blue-400/40 text-gray-100"
            >
              <option value="">Select fraud type</option>
              <option value="phishing">Phishing/Email Scam</option>
              <option value="voice">Phone/Voice Scam</option>
              <option value="sms">SMS Scam</option>
              <option value="banking">Banking Fraud</option>
              <option value="social">Social Media Scam</option>
            </select>
            
            <input
              type="text"
              placeholder="Phone number or email (optional)"
              value={newReport.phoneNumber}
              onChange={(e) => setNewReport(prev => ({ ...prev, phoneNumber: e.target.value }))}
              className="w-full p-3 rounded-lg bg-surface border border-blue-400/40 text-gray-100"
            />
            
            <textarea
              placeholder="Describe the fraud attempt..."
              value={newReport.description}
              onChange={(e) => setNewReport(prev => ({ ...prev, description: e.target.value }))}
              rows={3}
              className="w-full p-3 rounded-lg bg-surface border border-blue-400/40 text-gray-100"
            />
            
            <button
              onClick={submitReport}
              className="px-4 py-2 professional-button text-white rounded-lg"
            >
              🚨 Submit Report
            </button>
          </div>
        </div>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Educational Content (EXISTING) */}
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4">📚 Fraud Education</h4>
            <div className="space-y-3 text-gray-300 text-sm">
              <div className="p-3 bg-blue-900/30 rounded-lg">
                <strong className="text-blue-300">Common Phone Scams:</strong>
                <ul className="mt-2 space-y-1 ml-4">
                  <li>• Fake bank/credit card alerts</li>
                  <li>• Prize/lottery scams</li>
                  <li>• Tech support fraud</li>
                  <li>• Government impersonation</li>
                </ul>
              </div>
              <div className="p-3 bg-green-900/30 rounded-lg">
                <strong className="text-green-300">Red Flags:</strong>
                <ul className="mt-2 space-y-1 ml-4">
                  <li>• Urgent action required</li>
                  <li>• Request for sensitive info</li>
                  <li>• Unsolicited calls about money</li>
                  <li>• Pressure to decide quickly</li>
                </ul>
              </div>
            </div>
          </div>

          {/* Helpline Directory (EXISTING) */}
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4">🆘 Emergency Helplines</h4>
            <div className="space-y-3 text-gray-300 text-sm">
              <div className="space-y-2">
                <div className="flex justify-between items-center p-2 bg-gray-800/50 rounded">
                  <span>National Cyber Crime</span>
                  <span className="text-green-400 font-mono">1930</span>
                </div>
                <div className="flex justify-between items-center p-2 bg-gray-800/50 rounded">
                  <span>Consumer Helpline</span>
                  <span className="text-green-400 font-mono">1915</span>
                </div>
                <div className="flex justify-between items-center p-2 bg-gray-800/50 rounded">
                  <span>UP Mukhyamantri Helpline</span>
                  <span className="text-green-400 font-mono">1076</span>
                </div>
                <div className="flex justify-between items-center p-2 bg-gray-800/50 rounded">
                  <span>Railway Enquiry</span>
                  <span className="text-green-400 font-mono">139</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* 🔴 NEW: Recent Community Reports */}
        <div className="glass-panel p-4 rounded-xl mt-6">
          <h4 className="font-semibold text-cyan-300 mb-4">📋 Recent Community Reports</h4>
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {reports.length > 0 ? reports.map((report, index) => (
              <div key={report.id || index} className="p-3 bg-gray-800/50 rounded-lg">
                <div className="flex justify-between items-start mb-2">
                  <span className="text-yellow-400 font-semibold capitalize">
                    {report.category || report.type} Scam
                  </span>
                  <span className="text-xs text-gray-400">
                    {new Date(report.timestamp).toLocaleDateString()}
                  </span>
                </div>
                <p className="text-gray-300 text-sm">
                  {report.description?.substring(0, 100)}...
                </p>
                {report.phoneNumber && (
                  <p className="text-red-400 text-xs mt-1">📞 {report.phoneNumber}</p>
                )}
              </div>
            )) : (
              <div className="text-gray-400 text-center py-4">
                No community reports yet. Be the first to contribute!
              </div>
            )}
          </div>
        </div>

        {/* Community Settings (EXISTING) */}
        <div className="mt-6 glass-panel p-4 rounded-xl">
          <h4 className="font-semibold text-cyan-300 mb-4">⚙️ Community Settings</h4>
          <div className="space-y-3">
            <label className="flex items-center gap-3">
              <input
                type="checkbox"
                checked={settings.communitySettings.notifications}
                onChange={(e) => setSettings(prev => ({
                  ...prev,
                  communitySettings: {
                    ...prev.communitySettings,
                    notifications: e.target.checked
                  }
                }))}
                className="rounded"
              />
              <span className="text-gray-300">Receive fraud alert notifications</span>
            </label>
            <label className="flex items-center gap-3">
              <input
                type="checkbox"
                checked={settings.communitySettings.shareReports}
                onChange={(e) => setSettings(prev => ({
                  ...prev,
                  communitySettings: {
                    ...prev.communitySettings,
                    shareReports: e.target.checked
                  }
                }))}
                className="rounded"
              />
              <span className="text-gray-300">Share fraud reports with community (anonymous)</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  );
};

// Spam Section (EXISTING - UNCHANGED)
const SpamSection = () => {
  const { settings, setSettings } = useUserSettings();

  const updateSpamFilter = (category, enabled) => {
    setSettings(prev => ({
      ...prev,
      spamFilters: {
        ...prev.spamFilters,
        [category]: enabled
      }
    }));
  };

  return (
    <div className="space-y-6">
      <div className="glass-panel-elevated p-6 rounded-2xl">
        <h3 className="text-2xl font-bold text-blue-300 mb-6 flex items-center gap-3">
          🛡️ SMS & Spam Control
        </h3>
        <div className="space-y-6">
          {/* SMS Category Filters */}
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4">📱 SMS Category Filters</h4>
            <p className="text-gray-400 text-sm mb-4">
              Control which types of SMS messages you want to receive. Toggle categories on/off as needed.
            </p>
            <div className="grid md:grid-cols-2 gap-4">
              {Object.entries(settings.spamFilters).map(([category, enabled]) => (
                <label key={category} className="flex items-center justify-between glass-panel p-3 rounded-lg hover:border-blue-400/60 transition-colors cursor-pointer">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">
                      {category === 'jobs' ? '💼' :
                      category === 'advertisements' ? '📢' :
                      category === 'promotions' ? '🎁' :
                      category === 'internships' ? '🎓' :
                      category === 'banking' ? '🏦' : '📧'}
                    </span>
                    <span className="text-gray-300 capitalize font-medium">{category}</span>
                  </div>
                  <input
                    type="checkbox"
                    checked={enabled}
                    onChange={(e) => updateSpamFilter(category, e.target.checked)}
                    className="rounded scale-110"
                  />
                </label>
              ))}
            </div>
          </div>

          {/* Spam Statistics */}
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4">📊 Spam Statistics (Mock Data)</h4>
            <div className="grid grid-cols-3 gap-4">
              <div className="text-center p-3 bg-red-900/30 rounded-lg">
                <div className="text-2xl font-bold text-red-400">127</div>
                <div className="text-xs text-gray-400">Blocked Today</div>
              </div>
              <div className="text-center p-3 bg-yellow-900/30 rounded-lg">
                <div className="text-2xl font-bold text-yellow-400">1,205</div>
                <div className="text-xs text-gray-400">This Week</div>
              </div>
              <div className="text-center p-3 bg-green-900/30 rounded-lg">
                <div className="text-2xl font-bold text-green-400">98.2%</div>
                <div className="text-xs text-gray-400">Accuracy</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// Admin Section (EXISTING - UNCHANGED)
const AdminSection = () => {
  const { settings, setSettings } = useUserSettings();

  if (!settings.isAdmin) {
    return (
      <div className="glass-panel-elevated p-6 rounded-2xl text-center">
        <h3 className="text-2xl font-bold text-blue-300 mb-4">🔐 Admin Access</h3>
        <p className="text-gray-300 mb-4">This section is restricted to authorized personnel only.</p>
        <button
          onClick={() => {
            const password = prompt('Enter admin password:');
            if (password === 'admin123') { // Demo password
              setSettings(prev => ({ ...prev, isAdmin: true }));
            } else {
              alert('Invalid credentials');
            }
          }}
          className="px-4 py-2 professional-button text-white rounded-lg"
        >
          🔑 Admin Login
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="glass-panel-elevated p-6 rounded-2xl">
        <h3 className="text-2xl font-bold text-blue-300 mb-6 flex items-center gap-3">
          🔐 Admin Dashboard
        </h3>
        <div className="grid md:grid-cols-2 gap-6">
          {/* System Overview */}
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4">📊 System Overview</h4>
            <div className="space-y-3 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-400">Active Users:</span>
                <span className="text-green-400">1,247</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Spam Reports Today:</span>
                <span className="text-red-400">89</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">System Status:</span>
                <span className="text-green-400">Online</span>
              </div>
            </div>
          </div>

          {/* Quick Actions */}
          <div className="glass-panel p-4 rounded-xl">
            <h4 className="font-semibold text-cyan-300 mb-4">⚡ Quick Actions</h4>
            <div className="space-y-2">
              <button className="w-full p-2 bg-blue-600/30 border border-blue-400/50 rounded text-blue-300 hover:bg-blue-600/50 transition-colors text-sm">
                📊 Generate Reports
              </button>
              <button className="w-full p-2 bg-yellow-600/30 border border-yellow-400/50 rounded text-yellow-300 hover:bg-yellow-600/50 transition-colors text-sm">
                ⚠️ Broadcast Alert
              </button>
              <button className="w-full p-2 bg-red-600/30 border border-red-400/50 rounded text-red-300 hover:bg-red-600/50 transition-colors text-sm">
                🚫 Emergency Block
              </button>
            </div>
          </div>
        </div>

        <div className="mt-6 text-center">
          <button
            onClick={() => setSettings(prev => ({ ...prev, isAdmin: false }))}
            className="px-4 py-2 bg-gray-600/50 border border-gray-400/50 text-gray-300 rounded-lg hover:bg-gray-600/70 transition-colors"
          >
            🚪 Logout
          </button>
        </div>
      </div>
    </div>
  );
};

// Combined Input with Voice (EXISTING - ENHANCED)
const CombinedInput = ({
  value,
  onChange,
  onSubmit,
  disabled,
  isStreaming,
  apiKey,
  onSpeechResult
}) => {
  const [isListening, setIsListening] = useState(false);
  const [isSupported, setIsSupported] = useState(false);
  const recognitionRef = useRef(null);

  useEffect(() => {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      setIsSupported(true);
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = false;
      recognitionRef.current.interimResults = true;
      recognitionRef.current.lang = 'en-US';

      recognitionRef.current.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(result => result[0])
          .map(result => result.transcript)
          .join('');

        onChange({ target: { value: transcript } });
        if (event.results[event.results.length - 1].isFinal) {
          onSpeechResult(transcript);
          setIsListening(false);
        }
      };

      recognitionRef.current.onerror = () => {
        setIsListening(false);
      };

      recognitionRef.current.onend = () => {
        setIsListening(false);
      };
    }
  }, [onChange, onSpeechResult]);

  const toggleVoice = () => {
    if (!recognitionRef.current) return;

    if (isListening) {
      recognitionRef.current.stop();
      setIsListening(false);
    } else {
      onChange({ target: { value: '' } });
      recognitionRef.current.start();
      setIsListening(true);
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      onSubmit(e);
    }
  };

  return (
    <form onSubmit={onSubmit} className="p-4 lg:p-6 border-t border-blue-400/30 glass-panel">
      <div className="relative">
        <textarea
          value={value}
          onChange={onChange}
          onKeyDown={handleKeyDown}
          placeholder={
            isListening
            ? "🎤 Listening... Speak your question now"
            : apiKey
            ? "Type or speak your fact-checking question..."
            : "Please configure your API key first..."
          }
          rows={window.innerWidth < 768 ? 2 : 3}
          disabled={disabled || !apiKey}
          className={`w-full p-4 pr-20 lg:pr-24 rounded-xl bg-surface border text-gray-100 placeholder-gray-400 focus:outline-none transition-all duration-300 resize-none text-sm lg:text-base leading-relaxed
          ${isListening
            ? 'border-red-400 bg-red-900/20'
            : 'border-blue-400/40 focus:border-blue-400'
          }
          ${!apiKey ? 'opacity-50' : ''}
          `}
        />

        <div className="absolute right-2 top-2 flex flex-col gap-2">
          {isSupported && (
            <button
              type="button"
              onClick={toggleVoice}
              disabled={disabled || !apiKey}
              className={`
                p-2 lg:p-3 rounded-lg transition-all duration-300 font-medium text-xs lg:text-sm
                ${isListening
                  ? 'bg-red-500/30 border-2 border-red-400 text-red-300 animate-pulse-mic'
                  : 'glass-panel border border-blue-400/50 text-blue-300 hover:border-blue-400'
                }
                ${!apiKey ? 'opacity-50 cursor-not-allowed' : ''}
              `}
              title={isListening ? 'Stop recording' : 'Start voice input'}
            >
              {isListening ? '⏹️' : '🎤'}
            </button>
          )}

          <button
            type="submit"
            disabled={disabled || !value.trim() || !apiKey}
            className={`
              p-2 lg:p-3 rounded-lg transition-all duration-300 font-bold text-xs lg:text-sm
              ${disabled || !apiKey
                ? 'bg-gray-600/50 border border-gray-500/50 text-gray-400 cursor-not-allowed'
                : 'professional-button text-white hover:shadow-lg'
              }
            `}
            title="Send message"
          >
            🚀
          </button>
        </div>

        {isListening && (
          <div className="absolute bottom-2 left-4 flex items-center gap-2">
            <VoiceVisualizer isActive={true} />
            <span className="text-xs text-red-400 animate-pulse">Recording...</span>
          </div>
        )}

        {isStreaming && (
          <div className="absolute bottom-2 right-20 lg:right-24 text-blue-400 text-xs lg:text-sm font-mono animate-pulse">
            ⚡ Analyzing...
          </div>
        )}
      </div>
    </form>
  );
};

// Enhanced Message Component (EXISTING - ENHANCED)
const MessageBubble = ({ message, isStreaming, onSpeak, isSpeaking, onExpand }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [analysis, setAnalysis] = useState(null);
  const isUser = message.role === 'user';
  const time = message.timestamp.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

  // 🔴 NEW: Analyze user messages for risk
  useEffect(() => {
    if (isUser && message.content) {
      const behaviorAnalysis = AdvancedAIServices.analyzeBehavior(message.content);
      setAnalysis(behaviorAnalysis);
    }
  }, [isUser, message.content]);

  const summary = !isUser && message.content ? createSummary(message.content) : message.content;
  const needsExpansion = !isUser && message.content && message.content.length > 200;

  const handleToggleExpand = () => {
    if (needsExpansion) {
      setIsExpanded(!isExpanded);
      if (!isExpanded && onExpand) {
        onExpand(message.id);
      }
    }
  };

  const displayContent = isUser ? message.content : (isExpanded ? message.content : summary);

  return (
    <div className="animate-fade-in">
      <div className={`
        max-w-full lg:max-w-4xl p-4 lg:p-6 rounded-xl transition-all duration-300
        ${isUser
          ? 'ml-auto glass-panel border-blue-400/50'
          : 'mr-auto glass-panel-elevated border-cyan-400/50'
        }
        ${isStreaming ? 'animate-subtle-glow' : ''}
      `}>
        <div className="flex justify-between items-start mb-4">
          <div className="flex items-center gap-3 lg:gap-4">
            <div className={`
              w-8 lg:w-10 h-8 lg:h-10 rounded-lg flex items-center justify-center text-xs lg:text-sm font-bold
              ${isUser
                ? 'bg-blue-600/30 border border-blue-400/60 text-blue-200'
                : 'bg-cyan-600/30 border border-cyan-400/60 text-cyan-200'
              }
            `}>
              {isUser ? 'U' : 'AI'}
            </div>
            <div>
              <div className={`font-bold text-base lg:text-lg ${isUser ? 'text-blue-200' : 'text-cyan-200'}`}>
                {isUser ? 'Your Query' : 'AI Analysis'}
              </div>
              <div className="text-xs text-gray-400 font-mono flex items-center gap-2">
                <span>{time}</span>
               // Continue from where MessageBubble stopped...
                {isStreaming && (
                  <span className="text-cyan-400 animate-pulse">⚡ Live</span>
                )}
                {needsExpansion && !isExpanded && (
                  <span className="text-yellow-400">📄 Summary</span>
                )}
              </div>
            </div>
          </div>

          {/* 🔴 NEW: Risk Analysis for User Messages */}
          {isUser && analysis && analysis.riskScore > 0 && (
            <div className={`px-2 py-1 rounded text-xs font-semibold ${
              analysis.riskLevel === 'HIGH' ? 'bg-red-900/50 text-red-300' :
              analysis.riskLevel === 'MEDIUM' ? 'bg-yellow-900/50 text-yellow-300' :
              'bg-green-900/50 text-green-300'
            }`}>
              Risk: {analysis.riskLevel}
            </div>
          )}

          {!isUser && message.content && (
            <div className="flex items-center gap-2 lg:gap-3">
              {isSpeaking && <VoiceVisualizer isActive={true} />}
              <button
                onClick={() => onSpeak(displayContent)}
                className="p-2 lg:p-3 rounded-lg glass-panel border border-purple-400/40 text-purple-300 hover:border-purple-400 transition-colors duration-300"
                title="Listen to response"
              >
                <span className="hidden lg:inline">{isSpeaking ? '⏹️ Stop' : '🔊 Listen'}</span>
                <span className="lg:hidden">{isSpeaking ? '⏹️' : '🔊'}</span>
              </button>
            </div>
          )}
        </div>

        {/* 🔴 NEW: Risk Analysis Display */}
        {isUser && analysis && analysis.riskScore > 0 && (
          <div className="mb-4 p-3 bg-yellow-900/30 rounded-lg border border-yellow-400/50">
            <h5 className="text-yellow-300 font-semibold mb-2">🔍 Risk Analysis</h5>
            <div className="text-sm space-y-1">
              <div className="text-gray-300">Risk Score: {analysis.riskScore}/10</div>
              {analysis.patterns.map((pattern, index) => (
                <div key={index} className="text-yellow-300 text-xs">
                  • {pattern.category.toUpperCase()}: {pattern.matches.join(', ')}
                </div>
              ))}
              {analysis.recommendations.map((rec, index) => (
                <div key={index} className="text-blue-300 text-xs">
                  {rec}
                </div>
              ))}
            </div>
          </div>
        )}

        <div className="text-gray-100 leading-relaxed">
          <pre className="whitespace-pre-wrap font-sans text-sm lg:text-base">
            {displayContent}
            {isStreaming && <span className="streaming-cursor"></span>}
          </pre>
          {needsExpansion && (
            <div className="mt-4 pt-3 border-t border-gray-600">
              <button
                onClick={handleToggleExpand}
                className="flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300 transition-colors duration-300"
              >
                {isExpanded ? (
                  <>⬆️ Show Less</>
                ) : (
                  <>⬇️ Read More Details</>
                )}
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// Main Application (ENHANCED)
const App = () => {
  // Load saved API key and settings (EXISTING)
  const [apiKey, setApiKey] = useState(() => {
    return localStorage.getItem(API_KEY_STORAGE) || '';
  });

  const [settings, setSettings] = useState(() => {
    const saved = localStorage.getItem(SETTINGS_STORAGE);
    return saved ? JSON.parse(saved) : {
      model: 'deepseek/deepseek-r1:free',
      voiceRate: 1
    };
  });

  // 🔴 ENHANCED: Active section state with new sections
  const [activeSection, setActiveSection] = useState('engine');
  const [messages, setMessages] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isStreaming, setIsStreaming] = useState(false);
  const [inputValue, setInputValue] = useState('');
  const [streamingMessageId, setStreamingMessageId] = useState(null);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [speakingMessageId, setSpeakingMessageId] = useState(null);
  const [showMobileSettings, setShowMobileSettings] = useState(false);
  const messagesEndRef = useRef(null);

  // Get current date for AI context (EXISTING)
  const getCurrentDate = () => {
    const now = new Date();
    return now.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      timeZone: 'Asia/Kolkata'
    });
  };

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    localStorage.setItem(SETTINGS_STORAGE, JSON.stringify(settings));
  }, [settings]);

  const updateSettings = (newSettings) => {
    setSettings(prev => ({ ...prev, ...newSettings }));
  };

  const clearChat = () => {
    setMessages([]);
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
      setIsSpeaking(false);
      setSpeakingMessageId(null);
    }
  };

  const handleSpeechResult = (transcript) => {
    if (transcript.trim().length > 10) {
      setTimeout(() => {
        sendMessage();
      }, 1000);
    }
  };

  const speakText = useCallback((text, messageId) => {
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
      setIsSpeaking(false);
      setSpeakingMessageId(null);
      return;
    }

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = settings.voiceRate || 1;
    utterance.pitch = 1;
    utterance.volume = 0.8;

    utterance.onstart = () => {
      setIsSpeaking(true);
      setSpeakingMessageId(messageId);
    };

    utterance.onend = () => {
      setIsSpeaking(false);
      setSpeakingMessageId(null);
    };

    speechSynthesis.speak(utterance);
  }, [settings.voiceRate]);

  const addMessage = (role, content, model = null) => {
    const message = {
      id: Date.now().toString(),
      role,
      content,
      timestamp: new Date(),
      model
    };
    setMessages(prev => [...prev, message]);
    return message.id;
  };

  const updateMessage = (messageId, newContent) => {
    setMessages(prev => prev.map(msg =>
      msg.id === messageId
      ? { ...msg, content: newContent }
      : msg
    ));
  };

  // 🔴 ENHANCED: Send Message with Advanced AI Features
  const sendMessage = async (e) => {
    if (e) e.preventDefault();
    if (!inputValue.trim() || isLoading) return;

    if (!apiKey) {
      alert('Please enter your OpenRouter API key first!');
      return;
    }

    const userMessage = inputValue.trim();
    addMessage('user', userMessage);
    setInputValue('');
    setIsLoading(true);

    const assistantId = addMessage('assistant', '', settings.model);

    try {
      // 🔴 NEW: Multi-source verification
      const truthSynthesis = await AdvancedAIServices.synthesizeTruth(userMessage);
      const languageDetection = AdvancedAIServices.detectLanguage(userMessage);
      
      setIsStreaming(true);
      setStreamingMessageId(assistantId);

      // Enhanced system prompt with multi-source data
      const enhancedSystemPrompt = `You are a professional fact-checking system with advanced capabilities. Today's date is ${getCurrentDate()}. 

      CONTEXT: 
      - User query language detected: ${languageDetection.language}
      - Truth synthesis confidence: ${truthSynthesis.overallConfidence}
      - Available sources: ${truthSynthesis.sources.map(s => s.name).join(', ')}
      
      INSTRUCTIONS:
      1. Provide evidence-based analysis with clear conclusions
      2. If multiple sources disagree, explain the discrepancies
      3. Include confidence levels for your assessments
      4. Highlight any detected manipulation techniques in the query
      5. Provide educational context about the topic
      6. Suggest verification steps for the user
      
      ADDITIONAL CONTEXT:
      ${truthSynthesis.sources.map(source => `${source.name}: ${source.content}`).join('\n')}`;

      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json',
          'HTTP-Referer': window.location.origin,
          'X-Title': 'Professional AI Fact Verification Platform'
        },
        body: JSON.stringify({
          model: settings.model,
          messages: [
            {
              role: 'system',
              content: enhancedSystemPrompt
            },
            {
              role: 'user',
              content: userMessage
            }
          ],
          stream: true,
          temperature: 0.3,
          max_tokens: 2000
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullContent = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = line.slice(6).trim();
            if (data === '[DONE]') continue;
            if (data === '') continue;

            try {
              const parsed = JSON.parse(data);
              const delta = parsed.choices?.[0]?.delta?.content;
              if (delta) {
                fullContent += delta;
                updateMessage(assistantId, fullContent);
              }
            } catch (e) {
              console.log('Skipping invalid JSON:', data);
            }
          }
        }
      }

      // 🔴 NEW: Append source information
      if (truthSynthesis.sources.length > 0) {
        const sourceInfo = `\n\n📚 **Sources Consulted:**\n${truthSynthesis.sources.map(source => 
          `• ${source.name} (${Math.round(source.confidence * 100)}% confidence)${source.url ? ` - ${source.url}` : ''}`
        ).join('\n')}\n\n🎯 **Overall Confidence:** ${Math.round(truthSynthesis.overallConfidence * 100)}%`;
        
        updateMessage(assistantId, fullContent + sourceInfo);
      }

      if (fullContent) {
        setTimeout(() => {
          const summary = createSummary(fullContent);
          speakText(summary, assistantId);
        }, 500);
      }

    } catch (error) {
      console.error('Streaming failed, trying non-streaming:', error);
      setIsStreaming(false);

      try {
        const fallbackResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
            'HTTP-Referer': window.location.origin,
            'X-Title': 'Professional AI Fact Verification Platform'
          },
          body: JSON.stringify({
            model: settings.model,
            messages: [
              {
                role: 'system',
                content: `You are a professional fact-checking system. Today's date is ${getCurrentDate()}. Provide evidence-based analysis.`
              },
              {
                role: 'user',
                content: userMessage
              }
            ],
            stream: false,
            temperature: 0.3,
            max_tokens: 2000
          })
        });

        if (fallbackResponse.ok) {
          const fallbackData = await fallbackResponse.json();
          const fallbackMessage = fallbackData.choices[0].message.content;
          updateMessage(assistantId, fallbackMessage);

          setTimeout(() => {
            const summary = createSummary(fallbackMessage);
            speakText(summary, assistantId);
          }, 500);
        } else {
          const errorText = await fallbackResponse.text();
          console.error('Fallback API Error:', errorText);
          updateMessage(assistantId, `Sorry, I encountered an issue: ${fallbackResponse.status}. Please check your API key or try again.`);
        }
      } catch (fallbackError) {
        console.error('Both streaming and fallback failed:', fallbackError);
        updateMessage(assistantId, 'Analysis system temporarily unavailable. Please check your connection and API key.');
      }
    } finally {
      setIsLoading(false);
      setIsStreaming(false);
      setStreamingMessageId(null);
    }
  };

  const handleExpand = (messageId) => {
    console.log('Expanding message:', messageId);
  };

  return (
    <UserSettingsProvider>
      <div className="min-h-screen flex">
        <div className="flex-1 flex flex-col">
          {/* Header with Navigation (ENHANCED) */}
          <div className="p-4 lg:p-6 border-b border-blue-400/30 glass-panel">
            <div className="flex justify-between items-center mb-4">
              <div>
                <h1 className="text-xl lg:text-3xl font-display font-bold mb-2 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                  AI-Powered Security Platform
                </h1>
                <p className="text-sm lg:text-base text-gray-300 hidden sm:block">
                  Advanced fact verification, fraud detection & community protection
                </p>
              </div>
              <StatusIndicator
                status="ready"
                isProcessing={isLoading}
                isStreaming={isStreaming}
                apiKey={apiKey}
              />
            </div>

            {/* Navigation Tabs */}
            <NavigationTabs
              activeSection={activeSection}
              onSectionChange={setActiveSection}
            />
          </div>

          {/* Content Area with Conditional Rendering */}
          <div className="flex-1 overflow-y-auto p-4 lg:p-6">
            {activeSection === 'engine' && (
              <>
                <ApiKeyManager apiKey={apiKey} onApiKeyChange={setApiKey} />
                {messages.length === 0 ? (
                  <div className="max-w-4xl mx-auto text-center p-6 lg:p-12 glass-panel-elevated rounded-2xl border border-blue-400/40">
                    <div className="w-16 lg:w-20 h-16 lg:h-20 mx-auto mb-6 lg:mb-8 bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-2xl flex items-center justify-center border border-blue-400/40">
                      <span className="text-3xl lg:text-4xl">🎯</span>
                    </div>
                    <h3 className="text-2xl lg:text-3xl font-display font-bold mb-4 lg:mb-6 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                      Advanced AI Fact Verification
                    </h3>
                    <p className="text-gray-300 mb-4 leading-relaxed text-base lg:text-lg max-w-2xl mx-auto">
                      Multi-source verification with behavioral analysis. Get comprehensive fraud detection with educational insights.
                    </p>
                    <p className="text-blue-400 mb-6 lg:mb-8 font-semibold">
                      🎤 Voice input • 🔍 Multi-source verification • 🧠 Risk analysis • 📚 Educational insights
                    </p>
                  </div>
                ) : (
                  messages.map(message => (
                    <MessageBubble
                      key={message.id}
                      message={message}
                      isStreaming={streamingMessageId === message.id}
                      onSpeak={(text) => speakText(text, message.id)}
                      isSpeaking={speakingMessageId === message.id}
                      onExpand={handleExpand}
                    />
                  ))
                )}
                <div ref={messagesEndRef} />
              </>
            )}

            {/* Other Section Content */}
            {activeSection === 'analytics' && <AdvancedAnalyticsSection />}
            {activeSection === 'dialer' && <DialerSection />}
            {activeSection === 'community' && <CommunitySection />}
            {activeSection === 'spam' && <SpamSection />}
            {activeSection === 'education' && <EducationSection />}
            {activeSection === 'admin' && <AdminSection />}
          </div>

          {/* Input - Only show for engine section */}
          {activeSection === 'engine' && (
            <CombinedInput
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onSubmit={sendMessage}
              disabled={isLoading}
              isStreaming={isStreaming}
              apiKey={apiKey}
              onSpeechResult={handleSpeechResult}
            />
          )}
        </div>
      </div>
    </UserSettingsProvider>
  );
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>

